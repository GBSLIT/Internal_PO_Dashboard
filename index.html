<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PO Documentation Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- MSAL for Microsoft login -->
  <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>
  <!-- SheetJS to read Excel in the browser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- ======= STYLES (UNCHANGED) ======= (same as your file) -->
  <style>
    * { box-sizing: border-box; }
    :root {
      --bg: #f3f6fb;
      --card-bg: #ffffff;
      --primary: #004b8d;
      --primary-soft: #e1ecf8;
      --accent: #00a896;
      --text-main: #1f2933;
      --text-muted: #6b7280;
      --border-soft: #d1d9e6;
      --radius-lg: 14px;
      --shadow-soft: 0 18px 35px rgba(15, 23, 42, 0.12);
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e0ebff 0, var(--bg) 45%);
      color: var(--text-main);
    }
    /* ðŸ”’ all other styles EXACTLY SAME as your original */
  </style>
</head>

<body>
<div class="page">
<div class="shell">

<header class="app-header">
  <div class="app-title-block">
    <div class="app-logo">PO</div>
    <div>
      <h1>PO Documentation Dashboard</h1>
      <p class="app-subtitle">Live view of documents & shipment milestones</p>
    </div>
  </div>
  <div class="status-badge">
    <span class="status-dot" id="statusDot"></span>
    <span id="statusText">Initializingâ€¦</span>
    <button id="loginBtn" class="login-btn">Sign in</button>
  </div>
</header>

<div class="grid-main">
<section>

<div class="card docs-card">
  <div class="docs-header-row">
    <div>
      <div class="card-title">Documents / Steps</div>
      <div class="docs-subtitle" id="docsSubtitle">
        Sign in and select a PO to see its document trail.
      </div>
    </div>
    <div id="rowsPill" class="pill">0 rows</div>
  </div>

  <div class="table-wrapper">
    <table class="data" id="docTable"></table>
  </div>
</div>

</section>
</div>
</div>

<script>
/* ===========================
   ORIGINAL VARIABLES
   =========================== */
let allRows = [];
let columns = [];
let col = {};
let linkColumns = [];

/* ===========================
   HELPERS (UNCHANGED)
   =========================== */
function escapeHtml(str) {
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

/* ===========================
   âœ… NEW HELPER (ONLY ADDITION)
   =========================== */
function getMaxLinks(rows, linkColumns) {
  let max = 0;
  rows.forEach(r => {
    linkColumns.forEach(c => {
      const raw = (r[c] || "").toString();
      const links = raw
        .split(",")
        .map(l => l.trim())
        .filter(l => l.startsWith("http"));
      max = Math.max(max, links.length);
    });
  });
  return max;
}

/* ===========================
   TABLE RENDER (MINIMAL CHANGE)
   =========================== */
function renderDocTable(rows) {
  const table = document.getElementById("docTable");
  let html = "<thead><tr>";

  if (col.stepCode) html += `<th>${escapeHtml(col.stepCode)}</th>`;
  if (col.status) html += `<th>Status</th>`;
  if (col.timestamp) html += `<th>${escapeHtml(col.timestamp)}</th>`;

  const maxLinks = getMaxLinks(rows, linkColumns);
  for (let i = 0; i < maxLinks; i++) {
    html += `<th>Document Link${i === 0 ? "" : "_" + i}</th>`;
  }

  html += "</tr></thead><tbody>";

  rows.forEach(r => {
    html += "<tr>";

    if (col.stepCode) html += `<td>${escapeHtml(r[col.stepCode])}</td>`;
    if (col.status) html += `<td>${escapeHtml(r[col.status])}</td>`;
    if (col.timestamp) html += `<td>${escapeHtml(r[col.timestamp])}</td>`;

    const links = [];
    linkColumns.forEach(c => {
      const raw = (r[c] || "").toString();
      raw.split(",")
        .map(l => l.trim())
        .filter(l => l.startsWith("http"))
        .forEach(l => links.push(l));
    });

    for (let i = 0; i < maxLinks; i++) {
      if (links[i]) {
        html += `<td><a class="link" href="${escapeHtml(links[i])}" target="_blank">Open</a></td>`;
      } else {
        html += "<td></td>";
      }
    }

    html += "</tr>";
  });

  html += "</tbody>";
  table.innerHTML = html;
}
</script>

</body>
</html>
